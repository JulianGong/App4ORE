<?xml version="1.0"?>
<ScriptLibrary>
  
  <!-- Accumulator
       Inputs:
       Notional                        notional
       LongShort                       1 for a long, -1 for a short position
       Underlying                      underlying index
       PayCcy                          payment currency
       Expiry                          expiry date
       Settlement                      settlement date
       AccrStart                       accrual start date
       AccrEnd                         accrual end date
       dc                              daycounter
       FX0                             FX Spot
       CF                              Conversion Factor
       Strike                          [strikeL, strikeH]
       Coupon                          [couponL, couponH]
       ObserverDates                   observation dates
       Results:
       value                           npv of the option
       CurrentNotional                 current notional
       notionalCurrency                notional currency
  -->
  <Script>
    <Name>RangeAccrual</Name>
    <Script>
      <Code><![CDATA[
            NUMBER i, N, M, Payoff, accrTerm, rate, Outright[2]; 
            N = 0;
            M = 0;
            Outright[1] = FX0 + Strike[1] * CF;
            Outright[2] = FX0 + Strike[2] * CF;
            
            FOR i IN (1, SIZE(ObserverDates), 1) DO
              IF Underlying(ObserverDates[i]) >= Outright[1] AND Underlying(ObserverDates[i]) <= Outright[2] THEN
                 N = N + 1;
              ELSE
                 M = M + 1;
              END;
            END;
            
            accrTerm = dcf(dc, AccrStart, AccrEnd);
            rate = N/(N+M) * Coupon[2] + M/(N+M) *Coupon[1];
            Payoff = PAY(Notional* (1 + rate)* accrTerm, Expiry, Settlement, PayCcy);
            value = LongShort * Payoff;
        ]]></Code>
      <NPV>value</NPV>
      <Results>
        <Result rename="notionalCurrency">PayCcy</Result>
      </Results>

    </Script>
  </Script>
  
</ScriptLibrary>
